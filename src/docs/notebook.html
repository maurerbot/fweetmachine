---

title: Fweet


keywords: fastai
sidebar: home_sidebar



nb_path: "notebook.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: notebook.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Note `weasyprint` needs `apt-get install libcairo2 libpango-1.0-0 libpangocairo-1.0-0 libgdk-pixbuf2.0-0 libffi-dev shared-mime-info poppler-utils`</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">json_normalize</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">phonenumbers</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">sys</span> 


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======MODE=======&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FWEET_ENV&#39;</span><span class="p">,</span> <span class="s1">&#39;DEV&#39;</span><span class="p">))</span>
<span class="n">mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FWEET_ENV&#39;</span><span class="p">,</span> <span class="s1">&#39;DEV&#39;</span><span class="p">)</span>


<span class="c1"># os.environ[&#39;FWEET_ENV&#39;] = &#39;PROD&#39;</span>
<span class="c1"># TEMP WORKAROUND</span>
<span class="k">global</span> <span class="n">workspace</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FWEET_ENV&#39;</span><span class="p">,</span> <span class="s1">&#39;FWEET_ENV&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;PROD&#39;</span><span class="p">:</span>
     <span class="n">workspace</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/processing/notebook&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="c1">#  workspace = os.getcwd()</span>

     <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LOG_LEVEL&#39;</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">workspace</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LOG_LEVEL&#39;</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">))</span>


<span class="n">workspace</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>======MODE=======
DEV
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;/home/hafsa/Documents/repos/fweet/src&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;DEV&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Fetch-Mentions()">Fetch Mentions()<a class="anchor-link" href="#Fetch-Mentions()"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">PropertyMock</span>
<span class="c1">#takes in a twitter object</span>

<span class="k">def</span> <span class="nf">test_fetch_mentions</span><span class="p">():</span>
    <span class="c1">#Make a mock of the Twitter Resp object, not testing the Twitter Object or OAuth Object</span>
    <span class="c1">#because those are invoked methods</span>
    
    <span class="n">twitter_mock_valid_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="nb">type</span><span class="p">(</span><span class="n">twitter_mock_valid_response</span><span class="p">)</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">PropertyMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

    <span class="n">json_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;fixtures/mentions.json&quot;</span><span class="p">)</span>
    <span class="n">twitter_mock_valid_response</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">))</span>
    <span class="n">json_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="n">valid_resp_df</span><span class="p">,</span> <span class="n">valid_media</span><span class="p">,</span> <span class="n">valid_users</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">fetch_mentions</span><span class="p">(</span><span class="n">twitter_mock_valid_response</span><span class="p">)</span> 
    
<span class="c1">#     assert valid_resp_df ==             author_id    text  \</span>
<span class="c1"># 0  1034147061711679488  @LeBraat @TwitterDev @LeGuud There&#39;s enough @t...   </span>
<span class="c1"># 1            199566737  Apparently I&#39;m not the only one (of my test ac...   </span>
<span class="c1"># 2   930524282358325248           Can I join this @twitterdev love party?!   </span>
<span class="c1"># 3  1034147061711679488                    I love me some @twitterdev too!   </span>
<span class="c1"># 4            199566737  This is a test, but also a good excuse to expr...   </span>

<span class="c1"># lang      conversation_id                   id  </span>
<span class="c1"># 0   en  1375152449594523649  1375152598945312768  </span>
<span class="c1"># 1   en  1375152449594523649  1375152449594523649  </span>
<span class="c1"># 2   en  1375152043455873027  1375152043455873027  </span>
<span class="c1"># 3   en  1375151947360174082  1375151947360174082  </span>
<span class="c1"># 4   en  1375151827189137412  1375151827189137412  </span>
    
    <span class="k">assert</span> <span class="n">valid_media</span> <span class="o">==</span> <span class="p">[]</span>
    <span class="k">assert</span> <span class="n">valid_users</span> <span class="o">==</span> <span class="p">[</span> <span class="p">{</span>
        
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;LeStache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;1034147061711679488&quot;</span><span class="p">,</span>
        <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;urls&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://t.co/7IDoW8iFLm&quot;</span><span class="p">,</span>
                <span class="s2">&quot;expanded_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://twitter.com&quot;</span><span class="p">,</span>
                <span class="s2">&quot;display_url&quot;</span><span class="p">:</span> <span class="s2">&quot;twitter.com&quot;</span>
              <span class="p">}</span>
            <span class="p">]</span>
          <span class="p">},</span>
          <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;urls&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="mi">21</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="mi">44</span><span class="p">,</span>
                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://t.co/v6nxjDjZR3&quot;</span><span class="p">,</span>
                <span class="s2">&quot;expanded_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://google.com&quot;</span><span class="p">,</span>
                <span class="s2">&quot;display_url&quot;</span><span class="p">:</span> <span class="s2">&quot;google.com&quot;</span>
              <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;hashtags&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span>
              <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;mentions&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;lebraat&quot;</span>
              <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;cashtags&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="s2">&quot;twtr&quot;</span>
              <span class="p">}</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;LeStaache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2018-08-27T18:34:07.000Z&quot;</span>
      <span class="p">}</span> <span class="p">]</span>

   
    <span class="n">twitter_mock_invalid_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="nb">type</span><span class="p">(</span><span class="n">twitter_mock_invalid_response</span><span class="p">)</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">PropertyMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
    
    <span class="c1">#TESTING INVALID RESPONSE - UNCOMMENT AT THE END</span>

    <span class="c1"># invalid_response = twitter.fetch_mentions(twitter_mock_invalid_response)  #checking invalid resp</span>
    <span class="c1"># # #assert that the function will fail</span>
    <span class="c1"># invalid_response.assertRaises(SystemExit())</span>

    
<span class="k">def</span> <span class="nf">test_fetch_favorites</span><span class="p">():</span>

    <span class="n">twitter_mock_valid_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="nb">type</span><span class="p">(</span><span class="n">twitter_mock_valid_response</span><span class="p">)</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">PropertyMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

    <span class="n">json_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;fixtures/favorites.json&quot;</span><span class="p">)</span>
    <span class="n">twitter_mock_valid_response</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">))</span>
    <span class="n">json_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">valid_response</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">fetch_favorites</span><span class="p">(</span><span class="n">twitter_mock_valid_response</span><span class="p">)</span>
<span class="c1">#     assert valid_response ==                        created_at                   id               id_str  \</span>
<span class="c1"># 0  Tue May 14 17:58:31 +0000 2019  1128358947772145672  1128358947772145672   </span>

<span class="c1">#                                                 text  truncated  \</span>
<span class="c1"># 0  Through the Twitter Developer Labs program, we...       True   </span>

<span class="c1">#   in_reply_to_status_id in_reply_to_status_id_str in_reply_to_user_id  \</span>
<span class="c1"># 0                  None                      None                None   </span>

<span class="c1">#   in_reply_to_user_id_str in_reply_to_screen_name  ...  \</span>
<span class="c1"># 0                    None                    None  ...   </span>

<span class="c1">#   quoted_status.coordinates quoted_status.place quoted_status.contributors  \</span>
<span class="c1"># 0                      None                None                       None   </span>

<span class="c1">#   quoted_status.is_quote_status  quoted_status.retweet_count  \</span>
<span class="c1"># 0                         False                          169   </span>

<span class="c1">#    quoted_status.favorite_count quoted_status.favorited  \</span>
<span class="c1"># 0                           350                   False   </span>

<span class="c1">#    quoted_status.retweeted  quoted_status.possibly_sensitive  \</span>
<span class="c1"># 0                    False                             False   </span>

<span class="c1">#    quoted_status.lang  </span>
<span class="c1"># 0                  en </span>

    <span class="n">twitter_mock_invalid_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="nb">type</span><span class="p">(</span><span class="n">twitter_mock_invalid_response</span><span class="p">)</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">PropertyMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>    

    <span class="c1">#TESTING INVALID RESPONSE - UNCOMMENT AT THE END</span>
    <span class="c1">#invalid_response = twitter.fetch_mentions(twitter_mock_invalid_response)  #checking invalid resp</span>
    <span class="c1">##assert that the function will fail</span>
    <span class="c1">#invalid_response.assertRaises(SystemExit())</span>


<span class="k">def</span> <span class="nf">test_get_tweet_content</span><span class="p">():</span> 
  <span class="c1">#again not going to test the twitter method because invoked</span>
  <span class="n">row_test_fixture_pending</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span> <span class="p">:</span> <span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;conversation_id&quot;</span> <span class="p">:</span> <span class="mi">1234</span><span class="p">}</span>
  <span class="n">row_test_fixture_received</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span> <span class="p">:</span> <span class="s2">&quot;received&quot;</span><span class="p">,</span> <span class="s2">&quot;conversation_id&quot;</span> <span class="p">:</span> <span class="mi">1234</span><span class="p">}</span>

  <span class="n">row_fixture_not</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_received&quot;</span><span class="p">}</span> 
  <span class="n">bearer_token</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">bearer_token</span>

  <span class="n">twitter_mock_valid_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
  <span class="nb">type</span><span class="p">(</span><span class="n">twitter_mock_valid_response</span><span class="p">)</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">PropertyMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

  <span class="c1">#should just return the same thing</span>
  <span class="n">row_test</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">get_tweet_content</span><span class="p">(</span><span class="n">row_fixture_not</span><span class="p">,</span> <span class="n">bearer_token</span><span class="p">,</span><span class="n">twitter_mock_valid_response</span><span class="p">)</span>
  <span class="k">assert</span> <span class="n">row_test</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;not_received&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

  <span class="n">twitter_mock_invalid_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
  <span class="nb">type</span><span class="p">(</span><span class="n">twitter_mock_invalid_response</span><span class="p">)</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">PropertyMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>

  <span class="c1">#should return the row with status == pending</span>
  <span class="n">fail_resp_test</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">get_tweet_content</span><span class="p">(</span><span class="n">row_test_fixture_pending</span><span class="p">,</span> <span class="n">bearer_token</span><span class="p">,</span> <span class="n">twitter_mock_invalid_response</span><span class="p">)</span>
  <span class="k">assert</span> <span class="n">fail_resp_test</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;pending&#39;</span><span class="p">,</span> <span class="s1">&#39;conversation_id&#39;</span><span class="p">:</span> <span class="mi">1234</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

  <span class="c1">#making the user_id == author_id so we can test the if statement</span>
  <span class="n">json_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;fixtures/if_true_tweets.json&quot;</span><span class="p">)</span>
  <span class="n">twitter_mock_valid_response</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">))</span>
  <span class="n">json_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="c1">#making the user_id == author_id so we can test the if statement</span>

  <span class="n">pass_resp_test</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">get_tweet_content</span><span class="p">(</span><span class="n">row_test_fixture_pending</span><span class="p">,</span> <span class="n">bearer_token</span><span class="p">,</span> <span class="n">twitter_mock_valid_response</span><span class="p">)</span>
  
  <span class="c1">#user[&#39;id&#39;] == tweet[&#39;author_id]: </span>
  <span class="k">assert</span> <span class="n">pass_resp_test</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author_name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;test_name&quot;</span>
  <span class="k">assert</span> <span class="n">pass_resp_test</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author_profile_pic&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;https://test_url.com&quot;</span>
  <span class="k">assert</span> <span class="n">pass_resp_test</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author_verified&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span>
  <span class="k">assert</span> <span class="n">pass_resp_test</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author_location&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;test_location&quot;</span>
  <span class="k">assert</span> <span class="n">pass_resp_test</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author_username&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;test_username&quot;</span>
  <span class="c1">#this int also makes sure we test that the type casting of the algo</span>
  <span class="k">assert</span> <span class="n">pass_resp_test</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author_public_metrics.retweet_count&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;107&quot;</span>
  <span class="k">assert</span> <span class="n">pass_resp_test</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author_public_metrics.reply_count&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;31&quot;</span>
  <span class="k">assert</span> <span class="n">pass_resp_test</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author_public_metrics.like_count&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;258&quot;</span>
  <span class="c1">#append the media object</span>
  <span class="k">assert</span> <span class="n">pass_resp_test</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;media&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="p">[{</span><span class="s1">&#39;media_key&#39;</span><span class="p">:</span> <span class="s1">&#39;7_1138489597158199298&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;video&#39;</span><span class="p">}]</span>


  <span class="n">twitter_mock_valid_else_response</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
  <span class="nb">type</span><span class="p">(</span><span class="n">twitter_mock_valid_else_response</span><span class="p">)</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">PropertyMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

  <span class="n">json_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;fixtures/not_true_tweets.json&quot;</span><span class="p">)</span>
  <span class="n">twitter_mock_valid_else_response</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">))</span>
  <span class="n">json_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="c1">#this condition is false user[&#39;id&#39;] == tweet[&#39;auther_id]: </span>
  <span class="n">pass_resp_different_id</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">get_tweet_content</span><span class="p">(</span><span class="n">row_test_fixture_pending</span><span class="p">,</span> <span class="n">bearer_token</span><span class="p">,</span> <span class="n">twitter_mock_valid_else_response</span><span class="p">)</span>
  
  <span class="c1">#won&#39;t have the user author data, only media data, and row metrics data</span>

  <span class="c1"># assert pass_resp_different_id == {&#39;status&#39;: &#39;pending&#39;, &#39;conversation_id&#39;: 1234, &#39;content&#39;: &#39;🎺 da-dada-DAH! We’re introducing the first Twitter Developer Labs endpoints: \n\n✨GET/users and GET/tweets ✨\n\nLabs is now open to all developers to start experimenting today 👉 https://t.co/eNx4Wc3Qwj https://t.co/ucmZrJAYjk&#39;, &#39;author_public_metrics.retweet_count&#39;: &#39;107&#39;, &#39;author_public_metrics.reply_count&#39;: &#39;31&#39;, &#39;author_public_metrics.like_count&#39;: &#39;258&#39;, &#39;media&#39;: [{&#39;media_key&#39;: &#39;7_1138489597158199298&#39;, &#39;type&#39;: &#39;video&#39;}]}</span>



<span class="c1">#this method is never used</span>
<span class="k">def</span> <span class="nf">test_map_media_to_tweet</span><span class="p">():</span> 
    <span class="n">if_row_fixture</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;attachments&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s2">&quot;media_keys&quot;</span><span class="p">:</span> <span class="s2">&quot;123456&quot;</span><span class="p">}}</span>
    <span class="n">else_row_fixture</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1">#should just return [] attached to media</span>
    <span class="n">media</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">else_condition</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">map_media_to_tweet</span><span class="p">(</span><span class="n">else_row_fixture</span><span class="p">,</span> <span class="n">media</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">else_condition</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;media&#39;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="c1">#should return media key added to the media row</span>
    <span class="n">if_condition</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">map_media_to_tweet</span><span class="p">(</span><span class="n">if_row_fixture</span><span class="p">,</span> <span class="n">media</span><span class="p">)</span>
    <span class="c1">#is this correct?</span>

    <span class="k">assert</span> <span class="n">if_condition</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;attachments&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;media_keys&#39;</span><span class="p">:</span> <span class="s1">&#39;123456&#39;</span><span class="p">},</span> <span class="s1">&#39;media&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">]}</span>




<span class="k">def</span> <span class="nf">test_map_username_to_fweet</span><span class="p">():</span> 
  <span class="c1">#AUTHOR ID AND ID SHOULD BE INTS</span>
  <span class="n">test_fixture</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;author_id&quot;</span> <span class="p">:</span> <span class="mi">12345</span><span class="p">}</span>
  <span class="n">if_test_users</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span> <span class="p">:</span> <span class="mi">12345</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;test_name&quot;</span><span class="p">,</span> <span class="s2">&quot;profile_image_url&quot;</span> <span class="p">:</span> <span class="s2">&quot;https://test_url&quot;</span><span class="p">,</span> <span class="s2">&quot;verified&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;location&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_location&quot;</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_username&quot;</span><span class="p">}]</span>

  <span class="n">else_test_users</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span> <span class="p">:</span> <span class="mi">7457235</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;test_name&quot;</span><span class="p">,</span> <span class="s2">&quot;profile_image_url&quot;</span> <span class="p">:</span> <span class="s2">&quot;https://test_url&quot;</span><span class="p">,</span> <span class="s2">&quot;verified&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>   <span class="s2">&quot;location&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_location&quot;</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_username&quot;</span><span class="p">}]</span> 

  <span class="n">if_test_result</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">map_usernames_to_fweet</span><span class="p">(</span><span class="n">test_fixture</span><span class="p">,</span> <span class="n">if_test_users</span><span class="p">)</span>
  <span class="k">assert</span> <span class="n">if_test_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;test_name&quot;</span>
  <span class="k">assert</span> <span class="n">if_test_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;profile_pic&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;https://test_url&quot;</span>
  <span class="k">assert</span> <span class="n">if_test_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verified&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span>
  <span class="k">assert</span> <span class="n">if_test_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;test_location&quot;</span>
  <span class="k">assert</span> <span class="n">if_test_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;test_username&quot;</span>
  
  <span class="c1">#without the []</span>
  <span class="k">assert</span> <span class="n">if_test_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mention_obj&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">if_test_users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  
  <span class="n">else_test_result</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">map_usernames_to_fweet</span><span class="p">(</span><span class="n">test_fixture</span><span class="p">,</span> <span class="n">else_test_users</span><span class="p">)</span> 
  <span class="k">assert</span> <span class="n">else_test_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mention_users&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;test_username&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">else_test_users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_upload_media</span><span class="p">():</span> 
  <span class="c1">#can only test else condition because don&#39;t want to change mode to PROD </span>
  <span class="n">mode_fixture</span> <span class="o">=</span> <span class="s2">&quot;DEV&quot;</span>
  <span class="n">row_fixture</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">auth_fixture</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

  <span class="n">result</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">upload_media</span><span class="p">(</span><span class="n">row_fixture</span><span class="p">,</span> <span class="n">auth_fixture</span><span class="p">,</span> <span class="n">mode_fixture</span><span class="p">)</span>
  <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;media_id&quot;</span> <span class="p">:</span> <span class="kc">None</span><span class="p">}</span>



<span class="k">def</span> <span class="nf">test_send_tweet</span><span class="p">():</span> 
  <span class="n">row_fixture</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_id&quot;</span><span class="p">,</span> <span class="s2">&quot;media_id&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_media_id&quot;</span><span class="p">,</span> <span class="s2">&quot;reply&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_reply&quot;</span><span class="p">}</span>
  <span class="n">mode_fixture</span> <span class="o">=</span> <span class="s2">&quot;DEV&quot;</span>
  <span class="n">auth_fixture</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  

  <span class="n">test_fixture</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">send_tweet</span><span class="p">(</span><span class="n">row_fixture</span><span class="p">,</span> <span class="n">auth_fixture</span><span class="p">,</span> <span class="n">mode_fixture</span><span class="p">)</span>
  <span class="k">assert</span> <span class="n">test_fixture</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;test_id&quot;</span><span class="p">,</span> <span class="s2">&quot;media_id&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_media_id&quot;</span><span class="p">,</span> <span class="s2">&quot;reply&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_reply&quot;</span><span class="p">}</span>   
  <span class="c1">#returns same because prints statements - test those? </span>
  <span class="c1">#otherwise cannot test PROD mode </span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Materializer">Materializer<a class="anchor-link" href="#Materializer"> </a></h2><hr>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">storage</span>
<span class="kn">from</span> <span class="nn">pdf2image</span> <span class="kn">import</span> <span class="n">convert_from_path</span>

<span class="c1"># TODO: move to kubelt SDK</span>
<span class="k">class</span> <span class="nc">Materializer</span><span class="p">:</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FWEET_ENV&#39;</span><span class="p">,</span> <span class="s1">&#39;DEV&#39;</span><span class="p">)</span>

    <span class="c1"># Instantiates a client</span>
    <span class="n">__bucket_name</span> <span class="o">=</span> <span class="s2">&quot;fweet&quot;</span>
    <span class="n">__data_path</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
    <span class="c1">#because of the different modes, need a lambda function to figure out the file path</span>
    <span class="n">__fax_numbers_file_name</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span> <span class="p">:</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/fax.csv&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_path</span><span class="p">)</span>
    <span class="n">__last_exection_file_name</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span> <span class="p">:</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/last.txt&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_path</span><span class="p">)</span>
    <span class="n">__fweet_file_name</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span> <span class="p">:</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/fweet.json&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_path</span><span class="p">)</span>

    <span class="c1"># Creates the new bucket</span>
    <span class="n">__bucket</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#TEST</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;TEST&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__data_path</span> <span class="o">=</span> <span class="s1">&#39;fixtures&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;PROD&#39;</span><span class="p">:</span>
            <span class="c1"># TODO: this can be replaced with an SDK pull and set</span>
            <span class="c1"># secrets = kubelt.Secrets(env=&#39;ENV&#39;)</span>
            <span class="c1"># secrets.get(&#39;fweet_bucket_creds.json&#39;, &#39;%s/./config/gcloud/fweet_credentials.json&#39; % pathlib.Path().home() )</span>
            <span class="c1"># os.environ[&quot;GOOGLE_APPLICATION_CREDENTIALS&quot;] = &#39;./secret/credentials.json&#39;</span>

            <span class="n">storage_client</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__bucket</span> <span class="o">=</span> <span class="n">storage_client</span><span class="o">.</span><span class="n">bucket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__bucket_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;DEV&#39;</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;GOOGLE_APPLICATION_CREDENTIALS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;./secret/credentials.json&#39;</span>

        
        <span class="c1"># TODO: DEV mode will use /data path</span>
    
    <span class="c1">#for not in prod mode</span>
    <span class="k">def</span> <span class="nf">__blob_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;PROD&#39;</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_path</span><span class="p">))</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bucket</span><span class="o">.</span><span class="n">blob</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">blob</span><span class="o">.</span><span class="n">download_to_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blob</span>

    <span class="k">def</span> <span class="nf">__blob_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;PROD&#39;</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bucket</span><span class="o">.</span><span class="n">blob</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">blob</span><span class="o">.</span><span class="n">upload_from_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blob</span>

    <span class="k">def</span> <span class="nf">get_fax_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__blob_download</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fax_numbers_file_name</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fax_numbers_file_name</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">})</span>
        <span class="c1"># return pd.read_csv(self.__fax_numbers_file_name()).to_dict(orient=&#39;list&#39;)</span>
    
    <span class="c1">#because it&#39;s a text file, just look at the last execution    </span>
    <span class="k">def</span> <span class="nf">get_last_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__blob_download</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__last_exection_file_name</span><span class="p">())</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__last_exection_file_name</span><span class="p">(),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">last_execution</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">last_execution</span>

    <span class="c1">#typecast all the tweet info with the blob</span>
    <span class="k">def</span> <span class="nf">get_fweet_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__blob_download</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fweet_file_name</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fweet_file_name</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;conversation_id&#39;</span><span class="p">:</span> <span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="s1">&#39;fax_number&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">write_fax_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">})</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fax_numbers_file_name</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__blob_upload</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fax_numbers_file_name</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">set_last_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__last_exection_file_name</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__blob_upload</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__last_exection_file_name</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">write_fweet_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fweet_file_name</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__blob_upload</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fweet_file_name</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">write_fax_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">public</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blob_upload</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">signed_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">public</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;PROD&#39;</span><span class="p">:</span>
            <span class="n">signed_url</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">generate_signed_url</span><span class="p">(</span><span class="n">expiration</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">signed_url</span>

    <span class="k">def</span> <span class="nf">write_jpg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jpg</span><span class="p">,</span> <span class="n">public</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">blob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__blob_upload</span><span class="p">(</span><span class="n">jpg</span><span class="p">)</span>
        <span class="n">signed_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">public</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;PROD&#39;</span><span class="p">:</span>
            <span class="n">signed_url</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">generate_signed_url</span><span class="p">(</span><span class="n">expiration</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">signed_url</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Fax-Machine">Fax Machine<a class="anchor-link" href="#Fax-Machine"> </a></h2><hr>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">telnyx</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">FileSystemLoader</span>
<span class="kn">from</span> <span class="nn">weasyprint</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">CSS</span>
<span class="kn">from</span> <span class="nn">weasyprint.fonts</span> <span class="kn">import</span> <span class="n">FontConfiguration</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="k">class</span> <span class="nc">FaxMachine</span><span class="p">:</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FWEET_ENV&#39;</span><span class="p">,</span> <span class="s1">&#39;DEV&#39;</span><span class="p">)</span>

    <span class="n">rolodex</span> <span class="o">=</span> <span class="kc">None</span> 

    <span class="n">fweet_template</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">font_config</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tcss</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wcss</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">telnyx_app_id</span> <span class="o">=</span> <span class="s1">&#39;1617486772244055400&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">materializer</span><span class="p">):</span>
        <span class="c1">#instantiated in the constructor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rolodex</span> <span class="o">=</span> <span class="n">materializer</span><span class="o">.</span><span class="n">get_fax_numbers</span><span class="p">()</span>
        <span class="n">telnyx</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="s1">&#39;KEY0178E5E7B6C6DA17409A0E57C9ED18A3_EFFfwSbPAN6YpIDzsxlmHI&#39;</span>

        <span class="n">jinja_environment</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
            <span class="n">loader</span><span class="o">=</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/templates/&#39;</span> <span class="o">%</span> <span class="n">workspace</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fweet_template</span> <span class="o">=</span> <span class="n">jinja_environment</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;fweet.html&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">font_config</span> <span class="o">=</span> <span class="n">FontConfiguration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcss</span> <span class="o">=</span> <span class="n">CSS</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/static/css/tailwind.css&#39;</span> <span class="o">%</span> <span class="n">workspace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wcss</span> <span class="o">=</span> <span class="n">CSS</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/static/css/all.css&#39;</span> <span class="o">%</span> <span class="n">workspace</span><span class="p">,</span> <span class="n">font_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">font_config</span><span class="p">)</span>
    
    <span class="c1">#just return rolodex</span>
   <span class="c1">#not tested</span>
    <span class="k">def</span> <span class="nf">get_rolodex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rolodex</span>

    
    <span class="c1">#not tested</span>
    <span class="k">def</span> <span class="nf">has_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">telnyx_balance</span> <span class="o">=</span> <span class="n">telnyx</span><span class="o">.</span><span class="n">Balance</span><span class="o">.</span><span class="n">retrieve</span><span class="p">()</span>

        <span class="n">oc_balance_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://opencollective.com/fweet.json&#39;</span><span class="p">)</span>
        <span class="n">oc_balance</span> <span class="o">=</span> <span class="n">oc_balance_resp</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">telnyx_balance</span><span class="o">.</span><span class="n">available_credit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.007</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">oc_balance</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Out of ink! Please refill.&#39;</span><span class="p">)</span>
            <span class="c1"># TODO: send a tweet asking for ink refill with link to open collective</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    
    
    <span class="nd">@staticmethod</span>
    <span class="c1">#TESTED</span>
    <span class="c1">#called on run_set_instructions step, with each row of the df where the status value is null</span>
    <span class="k">def</span> <span class="nf">set_instruction</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="c1">#status == ?? None ??, just return as is??</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">row</span> <span class="c1">#wouldn&#39;t this always be true?</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;entities.hashtags&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">hashtag</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;entities.hashtags&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">hashtag</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;addfax&#39;</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;addfax&#39;</span>
                <span class="k">elif</span> <span class="n">hashtag</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fweet&#39;</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;conversation_id&#39;</span><span class="p">]:</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fweet&#39;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;conversation_id&#39;</span><span class="p">]:</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fweet&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: set a status to correctly let the user know they didn&#39;t use the hashtag right</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span>
        
        <span class="k">return</span> <span class="n">row</span>

           

    <span class="nd">@staticmethod</span>
    <span class="c1">#not tested because just a setter method</span>
    <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="nd">@staticmethod</span>
    <span class="c1">#TESTED</span>
    <span class="c1">#used in add fax_number, called with df where status==addfax</span>
    <span class="k">def</span> <span class="nf">parse_fax_number</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">favorites_df</span><span class="p">):</span>
        <span class="n">fax_user</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fax_number</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">is_approved</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;check approval&#39;</span><span class="p">)</span>
        <span class="c1"># print(row)</span>
        <span class="c1">#need to have one like</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;public_metrics.like_count&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">favorites_df</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;public_metrics.like_count&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># these are @fweetmachines favorites so the id_str is our id</span>
            <span class="n">tweet_df</span> <span class="o">=</span> <span class="n">favorites_df</span><span class="p">[</span><span class="n">favorites_df</span><span class="p">[</span><span class="s1">&#39;id_str&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">tweet_df</span><span class="p">)</span>
            
            <span class="c1">#only true when tweet_df is not empty</span>
            <span class="n">is_approved</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">tweet_df</span><span class="o">.</span><span class="n">empty</span>

        <span class="k">if</span> <span class="n">is_approved</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mention</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;entities.mentions&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">mention</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;fweetmachine&#39;</span><span class="p">:</span>
                    <span class="n">fax_user</span> <span class="o">=</span> <span class="s1">&#39;@</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mention</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reply&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Succesfully added @</span><span class="si">%s</span><span class="s1"> to fweet address book.&#39;</span> <span class="o">%</span> <span class="n">mention</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
           
            <span class="c1">#phone number regex</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(?\b[2-9][0-9]</span><span class="si">{2}</span><span class="s2">\)?[-. ]?[2-9][0-9]</span><span class="si">{2}</span><span class="s2">[-. ]?[0-9]</span><span class="si">{4}</span><span class="s2">\b&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]):</span>
                <span class="n">fax_number</span> <span class="o">=</span> <span class="n">phonenumbers</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="n">phonenumbers</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="s2">&quot;CA&quot;</span><span class="p">),</span> <span class="n">phonenumbers</span><span class="o">.</span><span class="n">PhoneNumberFormat</span><span class="o">.</span><span class="n">E164</span><span class="p">)</span>
            
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fax_added&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: add logic to deny a &quot;#addfax&quot; instruction</span>
            <span class="k">pass</span>


        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;new_fax_username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fax_user</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;new_fax_number&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">fax_number</span>
        <span class="k">return</span> <span class="n">row</span>
    
    <span class="nd">@staticmethod</span>
    <span class="c1">#TESTED</span>
    <span class="c1">#applied in analyze mentions step, with rolodex, and net_new_df </span>
    <span class="c1">#net_new_df is the df with the status &#39;fweet&#39; </span>
    <span class="k">def</span> <span class="nf">map_fax</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">rolodex</span><span class="p">):</span>
        <span class="n">records</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mention</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;entities.mentions&#39;</span><span class="p">]:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">mention</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
            <span class="c1">#PUT BACK deep=True</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1">#if we are the one tweeting, skip, put append at the end with status skip</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">username</span> <span class="o">==</span> <span class="s1">&#39;fweetmachine&#39;</span><span class="p">):</span>
                <span class="n">record</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;skip&#39;</span>
                <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1">#add username</span>
            <span class="n">record</span><span class="p">[</span><span class="s1">&#39;fax_username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Assumes handles map to one fax number. If not, change here to iterate.</span>
                <span class="c1">#fax row first entry is the username</span>
                <span class="n">fax_row</span> <span class="o">=</span> <span class="n">rolodex</span><span class="p">[</span><span class="n">rolodex</span><span class="p">[</span><span class="s1">&#39;handle&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;@</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">username</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;====ROLODEX===&#39;</span><span class="p">)</span>
                <span class="n">record</span><span class="p">[</span><span class="s1">&#39;fax_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fax_row</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
                <span class="n">record</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;received&#39;</span>
                <span class="n">record</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;200 OK, ciao&#39;</span>
                <span class="n">record</span><span class="p">[</span><span class="s1">&#39;reply&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Fax being processed for </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">username</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1"># Still add with status fax_404</span>
                <span class="n">record</span><span class="p">[</span><span class="s1">&#39;fax_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">record</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;denied&#39;</span>
                <span class="n">record</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;404 Not Found&#39;</span>
                <span class="n">record</span><span class="p">[</span><span class="s1">&#39;reply&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;No fax number found for </span><span class="si">%s</span><span class="s1">. </span><span class="se">\n\n</span><span class="s1"> Instructions to add a fax number is here: https://twitter.com/fweetmachine/status/1389675212573224962&#39;</span> <span class="o">%</span> <span class="n">username</span>

            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
         <span class="c1">#records is a list of records, which in itself is a list of usersname, fax_number, status, reason, reply   </span>
        <span class="k">return</span> <span class="n">records</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">fax_machine</span><span class="p">,</span> <span class="n">materializer</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">telnyx_mock</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;@fweetmachine&#39;</span><span class="p">)</span>
        <span class="c1">#writing pdf has the same problem as the jpg problem, so fix that </span>
        <span class="n">FAX_PDF</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/pdf/</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">.pdf&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">workspace</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;fax_number&#39;</span><span class="p">])</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">FAX_PDF</span><span class="p">))</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="n">html</span> <span class="o">=</span> <span class="n">fax_machine</span><span class="o">.</span><span class="n">fweet_template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">tweet</span><span class="o">=</span><span class="n">row</span><span class="p">)</span>
        <span class="n">whtml</span> <span class="o">=</span> <span class="n">HTML</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">html</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="n">whtml</span><span class="o">.</span><span class="n">write_pdf</span><span class="p">(</span><span class="n">FAX_PDF</span><span class="p">,</span> <span class="n">stylesheets</span><span class="o">=</span><span class="p">[</span><span class="n">fax_machine</span><span class="o">.</span><span class="n">wcss</span><span class="p">,</span> <span class="n">fax_machine</span><span class="o">.</span><span class="n">tcss</span><span class="p">],</span> <span class="n">font_config</span><span class="o">=</span><span class="n">fax_machine</span><span class="o">.</span><span class="n">font_config</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===PHONE NUMBA===&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;fax_number&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;fax_number&#39;</span><span class="p">]))</span>

        <span class="c1">#TODO: test these when the block below is refactored</span>
        <span class="n">TO_FAX</span> <span class="o">=</span> <span class="n">phonenumbers</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="n">phonenumbers</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;fax_number&#39;</span><span class="p">],</span> <span class="s2">&quot;CA&quot;</span><span class="p">),</span> <span class="n">phonenumbers</span><span class="o">.</span><span class="n">PhoneNumberFormat</span><span class="o">.</span><span class="n">E164</span><span class="p">)</span>
        <span class="n">FROM_FAX</span> <span class="o">=</span> <span class="n">phonenumbers</span><span class="o">.</span><span class="n">format_number</span><span class="p">(</span><span class="n">phonenumbers</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;+17093090259&#39;</span><span class="p">,</span> <span class="s2">&quot;CA&quot;</span><span class="p">),</span> <span class="n">phonenumbers</span><span class="o">.</span><span class="n">PhoneNumberFormat</span><span class="o">.</span><span class="n">E164</span><span class="p">)</span>
        <span class="n">APP_ID</span> <span class="o">=</span> <span class="n">fax_machine</span><span class="o">.</span><span class="n">telnyx_app_id</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">FAX_URL</span> <span class="o">=</span> <span class="n">materializer</span><span class="o">.</span><span class="n">write_fax_pdf</span><span class="p">(</span><span class="n">FAX_PDF</span><span class="p">)</span>

        <span class="c1"># use this to materialize to bucket and then set a url before tweeting response</span>
        <span class="c1">#need to assert that this is the valid location on the file system, and if this is written correctly, </span>
        <span class="c1">#it would test whether this is written correctly </span>
        

        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FAX_PDF</span>
     

        <span class="c1">#TODO: this code needs to be refactored for testability </span>
        <span class="n">telnyx_fax</span> <span class="o">=</span> <span class="n">telnyx_mock</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">telnyx_fax</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="s2">&quot;===STATUS=====&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">telnyx_fax</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===FAX===&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;PROD&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;debug mode on. skipping fax...&#39;</span><span class="p">)</span>
                <span class="c1">#telnyx_fax = type(&#39;obj&#39;, (object,), {&#39;status&#39;: &#39;queued&#39;})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">telnyx_fax</span> <span class="o">=</span> <span class="n">telnyx</span><span class="o">.</span><span class="n">Fax</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">from_</span><span class="o">=</span><span class="n">FROM_FAX</span><span class="p">,</span>
                    <span class="n">to</span><span class="o">=</span><span class="n">TO_FAX</span><span class="p">,</span>
                    <span class="n">media_url</span><span class="o">=</span><span class="n">FAX_URL</span><span class="p">,</span>
                    <span class="n">connection_id</span><span class="o">=</span><span class="n">APP_ID</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">telnyx_fax</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">telnyx_fax</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;queued&#39;</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;This Fweet has failed to send&#39;</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reply&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Paper jam: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="k">telnyx_fax</span>.status
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fax_failed&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Error sending fax.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Successfully sent.&#39;</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reply&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Fweet has been sent to @</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="k">row</span>[&#39;fax_username&#39;]
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sent&#39;</span>

        <span class="k">return</span> <span class="n">row</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">PropertyMock</span>

<span class="k">def</span> <span class="nf">test_set_instructions</span><span class="p">():</span>
    <span class="n">if_row_fixture</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="c1">#would return immediately</span>
    <span class="c1"># if row[&#39;status&#39;]:</span>
    <span class="c1">#          return row</span>
    <span class="n">test_else_fixture</span> <span class="o">=</span> <span class="n">fax</span><span class="o">.</span><span class="n">set_instruction</span><span class="p">(</span><span class="n">if_row_fixture</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">test_else_fixture</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">True</span> <span class="p">}</span>
    

    
    <span class="c1">#                 row[&#39;status&#39;] = &#39;ignore&#39;</span>
    <span class="c1">#if isinstance(row[&#39;entities.hashtags&#39;], list):</span>
    <span class="c1">#   if not row[&#39;status&#39;]:</span>
    <span class="c1">#             if row[&#39;id&#39;] != row[&#39;conversation_id&#39;]:</span>
    <span class="c1">#                 row[&#39;status&#39;] = &#39;fweet&#39;</span>
    <span class="n">if_row_fixture_entities</span> <span class="o">=</span>  <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;entities.hashtags&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_hashtag&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span> <span class="p">:</span> <span class="mi">1234</span><span class="p">,</span> <span class="s2">&quot;conversation_id&quot;</span> <span class="p">:</span> <span class="mi">1234</span><span class="p">}</span>
    <span class="n">test_if_row_fixture_entities</span> <span class="o">=</span> <span class="n">fax</span><span class="o">.</span><span class="n">set_instruction</span><span class="p">(</span><span class="n">if_row_fixture_entities</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">test_if_row_fixture_entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ignore&quot;</span>

    <span class="n">if_row_fixture_entities_not_equal</span> <span class="o">=</span>  <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;entities.hashtags&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_hashtag&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span> <span class="p">:</span> <span class="mi">1234</span><span class="p">,</span> <span class="s2">&quot;conversation_id&quot;</span> <span class="p">:</span> <span class="mi">4321</span><span class="p">}</span>
    <span class="n">test_if_row_fixture_entities_not_equal</span> <span class="o">=</span> <span class="n">fax</span><span class="o">.</span><span class="n">set_instruction</span><span class="p">(</span><span class="n">if_row_fixture_entities_not_equal</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">test_if_row_fixture_entities_not_equal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;fweet&quot;</span>

    
    <span class="c1">#    for hashtag in row[&#39;entities.hashtags&#39;]:</span>
    <span class="c1">#                 if row[&#39;status&#39;]:</span>
    <span class="c1">#                     break</span>

    <span class="n">if_row_fixture_entities_true</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;entities.hashtags&quot;</span> <span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;tag&quot;</span> <span class="p">:</span> <span class="s2">&quot;addfax&quot;</span><span class="p">}]}</span>
    <span class="n">test_if_row_fixture_entities_true</span> <span class="o">=</span> <span class="n">fax</span><span class="o">.</span><span class="n">set_instruction</span><span class="p">(</span><span class="n">if_row_fixture_entities_true</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">test_if_row_fixture_entities_true</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span>
    

    <span class="c1">##if isinstance(row[&#39;entities.hashtags&#39;], list):</span>
    <span class="c1">#if hashtag[&#39;tag&#39;] == &#39;addfax&#39;:</span>
    <span class="c1">#                row[&#39;status&#39;] = &#39;addfax&#39;</span>
    <span class="n">if_row_fixture_entities_false</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;entities.hashtags&quot;</span> <span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;tag&quot;</span> <span class="p">:</span> <span class="s2">&quot;addfax&quot;</span><span class="p">}]}</span>
    <span class="n">test_if_row_fixture_entities_false</span> <span class="o">=</span> <span class="n">fax</span><span class="o">.</span><span class="n">set_instruction</span><span class="p">(</span><span class="n">if_row_fixture_entities_false</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">test_if_row_fixture_entities_false</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;addfax&quot;</span>

    <span class="c1"># elif hashtag[&#39;tag&#39;] == &#39;fweet&#39; and row[&#39;id&#39;] != row[&#39;conversation_id&#39;]</span>
    <span class="c1">#                    row[&#39;status&#39;] = &#39;fweet&#39;</span>
    <span class="n">if_row_fixture_entities_false_fweet</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;entities.hashtags&quot;</span> <span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;tag&quot;</span> <span class="p">:</span> <span class="s2">&quot;fweet&quot;</span><span class="p">}],</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1234</span><span class="p">,</span> <span class="s2">&quot;conversation_id&quot;</span> <span class="p">:</span> <span class="mi">4321</span><span class="p">}</span>
    <span class="n">test_if_row_fixture_entities_fweet</span> <span class="o">=</span> <span class="n">fax</span><span class="o">.</span><span class="n">set_instruction</span><span class="p">(</span><span class="n">if_row_fixture_entities_false_fweet</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">test_if_row_fixture_entities_fweet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;fweet&quot;</span>


<span class="c1">#because this function has branches, in order to test all the possible outcomes, we need to have different test fixtures</span>


<span class="k">def</span> <span class="nf">test_fax_run</span><span class="p">():</span>
    <span class="c1">#(row, fax_machine, materializer, mode)</span>
    <span class="n">row_fixture</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span> <span class="p">:</span> <span class="s2">&quot;@fweetmachine&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span> <span class="s2">&quot;fax_number&quot;</span><span class="p">:</span> <span class="s2">&quot;123&quot;</span><span class="p">,</span> <span class="s2">&quot;fax_username&quot;</span><span class="p">:</span> <span class="s2">&quot;test_username&quot;</span><span class="p">}</span>
    <span class="c1">#because we need a fixture with functionality inside it, not just a dict, or int etc. we will need to use unittest.mock()</span>
    <span class="n">html_fixture</span> <span class="o">=</span> <span class="s2">&quot;hello world&quot;</span>
    <span class="n">workspace_fixture</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">fweet_template_mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">fweet_template_mock</span><span class="o">.</span><span class="n">render</span><span class="o">=</span><span class="n">MagicMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="n">html_fixture</span><span class="p">)</span>

    <span class="n">fax_machine_fixture</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="n">fax_machine_fixture</span><span class="o">.</span><span class="n">font_config</span> <span class="o">=</span> <span class="n">FontConfiguration</span><span class="p">()</span>
    <span class="n">fax_machine_fixture</span><span class="o">.</span><span class="n">tcss</span> <span class="o">=</span> <span class="n">CSS</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/static/css/tailwind.css&#39;</span> <span class="o">%</span> <span class="n">workspace_fixture</span><span class="p">)</span>
    <span class="n">fax_machine_fixture</span><span class="o">.</span><span class="n">wcss</span> <span class="o">=</span> <span class="n">CSS</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/static/css/all.css&#39;</span> <span class="o">%</span> <span class="n">workspace_fixture</span><span class="p">,</span> <span class="n">font_config</span><span class="o">=</span><span class="n">fax_machine_fixture</span><span class="o">.</span><span class="n">font_config</span><span class="p">)</span>
    <span class="n">fax_machine_fixture</span><span class="o">.</span><span class="n">fweet_template</span><span class="o">=</span><span class="n">fweet_template_mock</span>
    
     
    <span class="n">materializer_fixture</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="c1">#just use magicmock </span>
    <span class="n">materializer_fixture</span><span class="o">.</span><span class="n">write_fax_pdf</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;dummy_fax_url&quot;</span><span class="p">))</span>
    <span class="n">mode_fixture</span> <span class="o">=</span> <span class="s2">&quot;DEV&quot;</span>


    <span class="c1"># response_mock = Mock()</span>
    <span class="c1"># #response_mock.status_code = 200</span>
    <span class="n">telnyx_mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="nb">type</span><span class="p">(</span><span class="n">telnyx_mock</span><span class="p">)</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">PropertyMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="s2">&quot;queued&quot;</span><span class="p">)</span>
   
    
    <span class="n">result_row_queued</span> <span class="o">=</span> <span class="n">fax</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">row_fixture</span><span class="p">,</span> <span class="n">fax_machine_fixture</span><span class="p">,</span> <span class="n">materializer_fixture</span><span class="p">,</span> <span class="n">mode_fixture</span><span class="p">,</span> <span class="n">telnyx_mock</span><span class="o">=</span><span class="n">telnyx_mock</span><span class="p">)</span>
    <span class="c1">#pdf is present, so we assume that since it exists, it read right</span>
    <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;pdf&quot;</span> <span class="ow">in</span> <span class="n">result_row_queued</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result_row_queued</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">result_row_queued</span><span class="p">[</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Successfully sent.&quot;</span>
    <span class="c1">#shouldn&#39;t make a diff if you put an @ or not</span>
    <span class="k">assert</span> <span class="n">result_row_queued</span><span class="p">[</span><span class="s2">&quot;reply&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Fweet has been sent to @</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="k">result_row_queued</span>[&#39;fax_username&#39;]
    <span class="k">assert</span> <span class="n">result_row_queued</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sent&#39;</span>
    

    <span class="n">telnyx_mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
    <span class="nb">type</span><span class="p">(</span><span class="n">telnyx_mock</span><span class="p">)</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">PropertyMock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="s2">&quot;not_queued&quot;</span><span class="p">)</span>
    

    <span class="n">result_row_not_queued</span> <span class="o">=</span> <span class="n">fax</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">row_fixture</span><span class="p">,</span><span class="n">fax_machine_fixture</span><span class="p">,</span> <span class="n">materializer_fixture</span><span class="p">,</span> <span class="n">mode_fixture</span><span class="p">,</span> <span class="n">telnyx_mock</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;pdf&quot;</span> <span class="ow">in</span> <span class="n">result_row_queued</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result_row_not_queued</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">result_row_not_queued</span><span class="p">[</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;This Fweet has failed to send&#39;</span>
    <span class="c1">#this should read paper jam: not queued because we&#39;re calling it on the mock </span>
    <span class="k">assert</span> <span class="n">result_row_not_queued</span><span class="p">[</span><span class="s2">&quot;reply&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Paper jam: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span><span class="k">telnyx_mock</span>.status
    <span class="k">assert</span> <span class="n">result_row_not_queued</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fax_failed&#39;</span>




<span class="k">def</span> <span class="nf">test_parse_fax_number</span><span class="p">():</span> 
   
    <span class="n">fav_fixture</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;id_str&quot;</span> <span class="p">:</span> <span class="s2">&quot;1234&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;True&quot;</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># if row[&#39;public_metrics.like_count&#39;] &gt; 0:</span>
<span class="c1">#             # these are @fweetmachines favorites so the id_str is our id</span>
<span class="c1">#             tweet_df = favorites_df[favorites_df[&#39;id_str&#39;] == str(row[&#39;id&#39;])]</span>
<span class="c1">#             print(tweet_df)</span>
    <span class="c1">#having it as an int will test the type casting as well </span>
    <span class="n">if_row_fixture</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;public_metrics.like_count&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span> <span class="p">:</span> <span class="mi">1234</span><span class="p">,</span> <span class="s2">&quot;entities.mentions&quot;</span> <span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;not_fweet_machine&quot;</span><span class="p">}],</span>  <span class="s2">&quot;text&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_text&quot;</span><span class="p">}</span>
    <span class="n">else_row_fixture</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;public_metrics.like_count&quot;</span> <span class="p">:</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span> <span class="p">:</span> <span class="mi">1234</span><span class="p">,</span> <span class="s2">&quot;entities.mentions&quot;</span> <span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;fweetmachine&quot;</span><span class="p">}],</span>  <span class="s2">&quot;text&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_text&quot;</span> <span class="p">}</span>

<span class="c1">#only true if fweet_df is not empty, and not empty when the if statement is True</span>
<span class="c1"># if is_approved:</span>
<span class="c1">#             for mention in row[&#39;entities.mentions&#39;]:</span>
<span class="c1">#                 if mention[&#39;username&#39;] != &#39;fweetmachine&#39;:</span>
<span class="c1">#                     fax_user = &#39;@%s&#39; % mention[&#39;username&#39;]</span>
<span class="c1">#                     row[&#39;reply&#39;] = &#39;Succesfully added @%s to fweet address book.&#39; % mention[&#39;username&#39;]</span>
<span class="c1">#             #phone number regex</span>
<span class="c1">#             for match in re.findall(r&quot;\(?\b[2-9][0-9]{2}\)?[-. ]?[2-9][0-9]{2}[-. ]?[0-9]{4}\b&quot;, row[&#39;text&#39;]):</span>
<span class="c1">#                 fax_number = phonenumbers.format_number(phonenumbers.parse(match, &quot;CA&quot;), phonenumbers.PhoneNumberFormat.E164)</span>
            
<span class="c1">#             row[&#39;status&#39;] = &#39;fax_added&#39;</span>

    <span class="n">test_both_if</span> <span class="o">=</span> <span class="n">fax</span><span class="o">.</span><span class="n">parse_fax_number</span><span class="p">(</span><span class="n">if_row_fixture</span><span class="p">,</span> <span class="n">fav_fixture</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">test_both_if</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reply&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Succesfully added @</span><span class="si">%s</span><span class="s1"> to fweet address book.&#39;</span> <span class="o">%</span> <span class="n">if_row_fixture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entities.mentions&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">test_both_if</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;fax_added&#39;</span>
 
    
<span class="c1">#         else:</span>
<span class="c1">#             # TODO: add logic to deny a &quot;#addfax&quot; instruction</span>
<span class="c1">#             pass</span>
    <span class="n">test_else</span> <span class="o">=</span> <span class="n">fax</span><span class="o">.</span><span class="n">parse_fax_number</span><span class="p">(</span><span class="n">else_row_fixture</span><span class="p">,</span> <span class="n">fav_fixture</span><span class="p">)</span> 
    <span class="k">assert</span> <span class="n">test_else</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;new_fax_username&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">test_else</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;new_fax_number&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span>
   
   
<span class="k">def</span> <span class="nf">test_map_fax</span><span class="p">():</span>
    <span class="n">data_fixture</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fax_username&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_fweet_machine&quot;</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span> <span class="p">:</span> <span class="mi">54321</span><span class="p">}</span>
    <span class="n">rolodex_fixture</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s2">&quot;handle&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_fweet_machine&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_fixture</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="p">})</span>
    <span class="n">rolodex_fixture_true</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s2">&quot;handle&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_fweet_machine&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_fixture</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="p">})</span>
    <span class="n">if_row_fixture</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;entities.mentions&quot;</span> <span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;username&quot;</span> <span class="p">:</span> <span class="s2">&quot;fweetmachine&quot;</span><span class="p">}]}</span>
    <span class="n">else_row_fixture</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;entities.mentions&quot;</span> <span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;username&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_fweet_machine&quot;</span><span class="p">}]}</span>
    
<span class="c1">#         for mention in row[&#39;entities.mentions&#39;]:</span>
<span class="c1">#             username = mention[&#39;username&#39;]</span>
<span class="c1">#             record = row.copy(deep=True)</span>
<span class="c1">#             #if we are the one tweeting, skip, put append at the end with status skip</span>
<span class="c1">#             if (username == &#39;fweetmachine&#39;):</span>
<span class="c1">#                 record[&#39;status&#39;] = &#39;skip&#39;</span>
<span class="c1">#                 records.append(record)</span>
<span class="c1">#                 continue</span>
    
    <span class="n">test_if_fixture</span> <span class="o">=</span> <span class="n">fax</span><span class="o">.</span><span class="n">map_fax</span><span class="p">(</span><span class="n">if_row_fixture</span><span class="p">,</span> <span class="n">rolodex_fixture</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">test_if_fixture</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;skip&#39;</span>

    <span class="n">test_else_fixture</span> <span class="o">=</span> <span class="n">fax</span><span class="o">.</span><span class="n">map_fax</span><span class="p">(</span><span class="n">else_row_fixture</span><span class="p">,</span> <span class="n">rolodex_fixture</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">test_else_fixture</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">test_else_fixture</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fax_username&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;not_fweet_machine&#39;</span>
    <span class="k">assert</span> <span class="n">test_else_fixture</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;received&#39;</span>
    <span class="k">assert</span> <span class="n">test_else_fixture</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;200 OK, ciao&#39;</span>
    <span class="k">assert</span> <span class="n">test_else_fixture</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reply&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Fax being processed for </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">test_else_fixture</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entities.mentions&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span>

    <span class="c1">#test except block</span>
    
    <span class="c1"># test_else_fixture_true = fax.map_fax(else_row_fixture, rolodex_fixture_true)</span>
    <span class="c1"># test_else_fixture_true.assertRaises(IndexError)</span>
    <span class="c1"># assert test_else_fixture_true[0].get(&quot;fax_number&quot;) == None</span>
    <span class="c1"># assert test_else_fixture_true[0].get(&quot;status&quot;) == &#39;denied&#39;</span>
    <span class="c1"># assert test_else_fixture_true[0].get(&quot;reason&quot;) == &#39;404 Not found&#39;</span>
    <span class="c1"># assert test_else_fixture_true[0].get(&quot;reply&quot;) == &#39;No fax number found for %s. \n\n Instructions to add a fax number is here: https://twitter.com/fweetmachine/status/1389675212573224962&#39; % test_else_fixture_true[0].get(&quot;entities.mentions&quot;)[0].get(&#39;username&#39;)</span>
     
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Fweet-Machine-App">Fweet Machine App<a class="anchor-link" href="#Fweet-Machine-App"> </a></h1><hr>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Process-Sent">Process Sent<a class="anchor-link" href="#Process-Sent"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">process_sent</span><span class="p">(</span><span class="n">sent_df</span><span class="p">,</span> <span class="n">completed_df</span><span class="p">):</span>
    <span class="c1"># poll telynx</span>
    <span class="k">return</span> <span class="n">sent_df</span><span class="p">,</span> <span class="n">completed_df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Process-Faxes">Process Faxes<a class="anchor-link" href="#Process-Faxes"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1">#TESTED</span>
<span class="c1">#called in faxing_df, where if the fax has balance, apply convert from path to each row, </span>
<span class="c1">#turn the pdf header to jpg, limit 500</span>
<span class="k">def</span> <span class="nf">generate_jpg_from_pdf</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="n">convert_from_path</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pdf&#39;</span><span class="p">],</span> <span class="mi">500</span><span class="p">)</span>
    <span class="c1">#iterating page correctly?</span>
    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
        <span class="c1">#building path correctly?</span>
        <span class="n">jpg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/jpg/</span><span class="si">%s</span><span class="s1">.jpg&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">workspace</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;pdf&#39;</span><span class="p">]))[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">#writing the jpg correctly, we know that this does not work when no jpg folder in dir, </span>
        <span class="c1">#so a way to make it better is to use a pythonlib called pathlib</span>
        <span class="c1">#make sure path exists</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">jpg</span><span class="p">))</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="n">page</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">jpg</span><span class="p">,</span> <span class="s1">&#39;JPEG&#39;</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">signed_url</span> <span class="o">=</span> <span class="n">materializer</span><span class="o">.</span><span class="n">write_jpg</span><span class="p">(</span><span class="n">jpg</span><span class="p">)</span>

        <span class="c1">#return a df with jpg_url, and jpg </span>
        <span class="c1">#mutate row correctly?</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;jpg_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signed_url</span>
        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;jpg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jpg</span>
        <span class="k">return</span> <span class="n">row</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_generate_jpg_from_pdf</span><span class="p">():</span> 
    
    <span class="kn">import</span> <span class="nn">urllib</span>

    <span class="n">fixture_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s2">&quot;pdf&quot;</span> <span class="p">:</span> <span class="s2">&quot;./fixtures/1387474633679585280.pdf&quot;</span><span class="p">})</span>
    <span class="n">result_row</span> <span class="o">=</span> <span class="n">generate_jpg_from_pdf</span><span class="p">(</span><span class="n">fixture_row</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;jpg_url&quot;</span> <span class="ow">in</span> <span class="n">result_row</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="s2">&quot;jpg&quot;</span> <span class="ow">in</span> <span class="n">result_row</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">result_row</span><span class="p">[</span><span class="s1">&#39;jpg&#39;</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">result_row</span><span class="p">[</span><span class="s1">&#39;jpg_url&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Not tested because the methods called within are already tested </span>
<span class="k">def</span> <span class="nf">process_fax</span><span class="p">(</span><span class="n">faxing_df</span><span class="p">):</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">fax</span><span class="o">.</span><span class="n">has_balance</span><span class="p">()):</span>
        <span class="c1"># TODO: send a tweet that we are are out of ink and to donate (once every 4)</span>
        <span class="k">return</span>

    <span class="n">faxing_df</span> <span class="o">=</span> <span class="n">faxing_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fax</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">fax</span><span class="p">,</span><span class="n">materializer</span><span class="p">,</span><span class="n">fax</span><span class="o">.</span><span class="n">mode</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">faxing_df</span> <span class="o">=</span> <span class="n">faxing_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">generate_jpg_from_pdf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#returns a df with jpg, and jpg url (jpg of the fax that needs to be sent)</span>
    <span class="n">faxing_df</span> <span class="o">=</span> <span class="n">faxing_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">twitter</span><span class="o">.</span><span class="n">upload_media</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">twitter</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span> <span class="n">twitter</span><span class="o">.</span><span class="n">mode</span><span class="p">,),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">faxing_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">twitter</span><span class="o">.</span><span class="n">send_tweet</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">twitter</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span> <span class="n">twitter</span><span class="o">.</span><span class="n">mode</span><span class="p">,),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">faxing_df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Process-Pending">Process Pending<a class="anchor-link" href="#Process-Pending"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#TESTED</span>
<span class="k">def</span> <span class="nf">process_pending</span><span class="p">(</span><span class="n">pending_df</span><span class="p">):</span>
    <span class="c1"># Move recieved to pending status (straight assignment because there is currently no review process)</span>
    <span class="c1"># TODO: some approval criteria (e.g. public metrics)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Some validation ideas:</span>
<span class="sd">    - NFT (new fax token with 50% resell comish)</span>
<span class="sd">    - Only Fweet Tweets from users that follow @fweet machine</span>
<span class="sd">    - Possibly so like and retweet criteria</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: use state transition function</span>
    <span class="n">pending_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pending_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;received&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Fweet has been approved&#39;</span> 
    <span class="n">pending_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pending_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;received&#39;</span><span class="p">,</span> <span class="s1">&#39;reply&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Your fax is now queued for sending.&#39;</span> 
    <span class="n">pending_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pending_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;received&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span> 

    <span class="c1">#is this just good practise? because won&#39;t ever get here??</span>
    <span class="n">pending_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pending_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;denied&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;dead letter&#39;</span> 

    <span class="k">return</span> <span class="n">pending_df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_pending_df</span><span class="p">():</span>
    <span class="n">pending_df_fixture_recieved</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;status&quot;</span> <span class="p">:</span> <span class="s2">&quot;received&quot;</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pending_df_fixture_denied</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;status&quot;</span> <span class="p">:</span> <span class="s2">&quot;denied&quot;</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">process_pending</span><span class="p">(</span><span class="n">pending_df_fixture_recieved</span><span class="p">)</span>
    <span class="c1">#assert result ==     status                   reason                                reply</span>
    <span class="c1">#0  pending  Fweet has been approved  Your fax is now queued for sending.</span>

    <span class="n">denied</span> <span class="o">=</span> <span class="n">process_pending</span><span class="p">(</span><span class="n">pending_df_fixture_denied</span><span class="p">)</span>
<span class="c1">#     assert denined ==       status reason reply</span>
<span class="c1">#     0  dead letter    NaN   NaN</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Analyze-Mentions">Analyze Mentions<a class="anchor-link" href="#Analyze-Mentions"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">analyze_mentions</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">,</span> <span class="n">media</span><span class="p">,</span> <span class="n">users</span><span class="p">):</span> 
    <span class="n">net_new_df</span> <span class="o">=</span> <span class="n">fweet_df</span><span class="p">[</span><span class="n">fweet_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fweet&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;fax_number&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">})</span>
    <span class="n">not_net_new_df</span> <span class="o">=</span> <span class="n">fweet_df</span><span class="p">[</span><span class="n">fweet_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;fweet&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;fax_number&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">})</span>
    
    <span class="c1"># Look up fax numbers for everything without a status because we haven&#39;t operated on it yet.</span>
    <span class="c1"># if the df has status fweet, then apply map_fax, which return a list of records to the new df</span>
    <span class="c1">#will always return, either records or error</span>
    <span class="n">net_new_rows</span> <span class="o">=</span> <span class="n">net_new_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fax</span><span class="o">.</span><span class="n">map_fax</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">fax</span><span class="o">.</span><span class="n">get_rolodex</span><span class="p">(),),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#only if no new fweet status</span>
    <span class="k">if</span> <span class="n">net_new_rows</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fweet_df</span>

    <span class="c1">#squash the list of lists of lists, into one    </span>
    <span class="n">username_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">net_new_rows</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
    <span class="c1">#username_df rows, with the fax number as a string</span>
    <span class="n">username_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">username_rows</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;fax_number&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">})</span>

    <span class="c1"># Get user and media data for new users.</span>
    <span class="c1"># now, look at the username_df, and if the name feild is null, which means these are new tweets</span>
    <span class="n">new_users_df</span> <span class="o">=</span> <span class="n">username_df</span><span class="p">[</span><span class="n">username_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
    <span class="c1"># populated_new_users_df = new_users_df.apply(twitter.map_media_to_tweet, args=(media,), axis=1)</span>

    <span class="c1">#adds the user information into the df</span>
    <span class="n">populated_new_users_df</span> <span class="o">=</span> <span class="n">new_users_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">twitter</span><span class="o">.</span><span class="n">map_usernames_to_fweet</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">users</span><span class="p">,),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Add the new data back to the received dataframe.</span>
    <span class="c1">#return df</span>
    <span class="n">fweet_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">not_net_new_df</span><span class="p">,</span> <span class="n">populated_new_users_df</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fweet_df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_analyze_mentions</span><span class="p">():</span>
    <span class="n">media_fixture</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">user_fixture</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fweet_df_fixture_false</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;status&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_fweet&quot;</span><span class="p">,</span> <span class="s2">&quot;fax_number&quot;</span><span class="p">:</span> <span class="mi">1234</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1">#should just get the df back</span>
    <span class="n">not_new_result</span> <span class="o">=</span> <span class="n">analyze_mentions</span><span class="p">(</span><span class="n">fweet_df_fixture_false</span><span class="p">,</span> <span class="n">media_fixture</span><span class="p">,</span> <span class="n">user_fixture</span><span class="p">)</span>
    <span class="c1"># assert now_new_result ==       status  fax_number</span>
    <span class="c1">#                             0  not_fweet        1234    </span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Steps">Steps<a class="anchor-link" href="#Steps"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">run_bootstrap_step</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FWEET_ENV&#39;</span><span class="p">,</span> <span class="s1">&#39;DEV&#39;</span><span class="p">))</span>

    <span class="c1"># bootstrap twitter</span>
    <span class="k">global</span> <span class="n">twitter</span>
    <span class="n">twitter</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">()</span>
    <span class="n">twitter</span><span class="o">.</span><span class="n">load_bearer_token</span><span class="p">()</span>

    <span class="k">global</span> <span class="n">materializer</span>
    <span class="n">materializer</span> <span class="o">=</span> <span class="n">Materializer</span><span class="p">()</span>

    <span class="k">global</span> <span class="n">fax</span>
    <span class="n">fax</span> <span class="o">=</span> <span class="n">FaxMachine</span><span class="p">(</span><span class="n">materializer</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">run_received_step</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">,</span> <span class="n">media</span><span class="p">,</span> <span class="n">users</span><span class="p">):</span>
    <span class="n">fweet_df</span> <span class="o">=</span> <span class="n">analyze_mentions</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">,</span> <span class="n">media</span><span class="p">,</span> <span class="n">users</span><span class="p">)</span>
        
    <span class="c1"># Respond to net new Tweets in the updated recieved dataframe</span>
    <span class="n">failed_df</span> <span class="o">=</span> <span class="n">fweet_df</span><span class="p">[(</span><span class="n">fweet_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;denied&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">fweet_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;failed&#39;</span><span class="p">)]</span>
    <span class="n">not_failed_df</span> <span class="o">=</span> <span class="n">fweet_df</span><span class="p">[(</span><span class="n">fweet_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;denied&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">fweet_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;failed&#39;</span><span class="p">)]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===GETTING CONTENT====&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">not_failed_df</span><span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;conversation_id&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">]])</span>

    <span class="n">failed_df</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">failed_df</span> <span class="o">=</span> <span class="n">failed_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fax</span><span class="o">.</span><span class="n">set_status</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;denied_complete&#39;</span><span class="p">,),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># not failed df, if contains not rows with status pending or recieved, just returns the same df</span>
    <span class="c1"># so, if the tweet has not been denied or failed, and the status is pending or recieved, populate the df the all the information of the tweet and put in this df</span>
    <span class="n">not_failed_df</span> <span class="o">=</span> <span class="n">not_failed_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">twitter</span><span class="o">.</span><span class="n">get_tweet_content</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">twitter</span><span class="o">.</span><span class="n">bearer_token</span><span class="p">,),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1">#concat everything, and return</span>
    <span class="n">fweet_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">not_failed_df</span><span class="p">,</span> <span class="n">failed_df</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># write back</span>
    <span class="n">materializer</span><span class="o">.</span><span class="n">write_fweet_df</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fweet_df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">run_approval_step</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">):</span>
    <span class="n">pending_df</span> <span class="o">=</span> <span class="n">fweet_df</span><span class="p">[</span><span class="n">fweet_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;received&#39;</span><span class="p">]</span>
    <span class="n">not_pending_df</span> <span class="o">=</span> <span class="n">fweet_df</span><span class="p">[</span><span class="n">fweet_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;received&#39;</span><span class="p">]</span>

    <span class="c1"># pending_df = pending_df.reset_index(drop=True).truncate(before=-1, after=-1)</span>
    <span class="c1"># pending_df[&#39;id&#39;] = None</span>
    <span class="c1"># pending_df[&#39;fax_username&#39;] = None</span>

    <span class="c1">#update reason, reply for status == recieved</span>
    <span class="c1">#set reply, and reason and status as pending</span>
    <span class="n">pending_df</span> <span class="o">=</span> <span class="n">process_pending</span><span class="p">(</span><span class="n">pending_df</span><span class="p">)</span>

    <span class="c1">#concat those</span>
    <span class="n">fweet_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">not_pending_df</span><span class="p">,</span> <span class="n">pending_df</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#write back</span>
    <span class="n">materializer</span><span class="o">.</span><span class="n">write_fweet_df</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fweet_df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">run_fax_step</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">):</span>
    <span class="n">faxing_df</span> <span class="o">=</span> <span class="n">fweet_df</span><span class="p">[</span><span class="n">fweet_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pending&#39;</span><span class="p">]</span>
    <span class="n">not_faxing_df</span> <span class="o">=</span> <span class="n">fweet_df</span><span class="p">[</span><span class="n">fweet_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;pending&#39;</span><span class="p">]</span>
    
    <span class="c1">#returns a df with row jpg, and jpg url </span>
    <span class="n">faxing_df</span> <span class="o">=</span> <span class="n">process_fax</span><span class="p">(</span><span class="n">faxing_df</span><span class="p">)</span>

    <span class="c1">#concat with the new status of the df and return</span>
    <span class="n">fweet_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">not_faxing_df</span><span class="p">,</span> <span class="n">faxing_df</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># write back</span>
    <span class="n">materializer</span><span class="o">.</span><span class="n">write_fweet_df</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fweet_df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">run_complete_step</span><span class="p">():</span>
    <span class="n">sent_df</span> <span class="o">=</span> <span class="n">materializer</span><span class="o">.</span><span class="n">get_sent_df</span><span class="p">()</span>
    <span class="n">completed</span> <span class="o">=</span> <span class="n">materializer</span><span class="o">.</span><span class="n">get_completed_df</span><span class="p">()</span>

    <span class="n">sent_df</span><span class="p">,</span> <span class="n">completed_df</span> <span class="o">=</span> <span class="n">process_sent</span><span class="p">(</span><span class="n">sent_df</span><span class="p">,</span> <span class="n">completed_df</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">run_add_fax_number_step</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">):</span>
    <span class="n">favorites_df</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">fetch_favorites</span><span class="p">()</span>
    <span class="n">add_fax_df</span> <span class="o">=</span> <span class="n">fweet_df</span><span class="p">[</span><span class="n">fweet_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;addfax&#39;</span><span class="p">]</span>
    <span class="n">not_add_fax_df</span> <span class="o">=</span> <span class="n">fweet_df</span><span class="p">[</span><span class="n">fweet_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;addfax&#39;</span><span class="p">]</span>

    <span class="c1">#adds fax number and username to where status addfax</span>
    <span class="n">add_fax_df</span> <span class="o">=</span> <span class="n">add_fax_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fax</span><span class="o">.</span><span class="n">parse_fax_number</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">favorites_df</span><span class="p">,),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#so all the new fax_number and usernames are then turned to a new df</span>
    <span class="n">new_fax_df</span> <span class="o">=</span> <span class="n">add_fax_df</span><span class="p">[(</span><span class="n">add_fax_df</span><span class="p">[</span><span class="s1">&#39;new_fax_username&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">add_fax_df</span><span class="p">[</span><span class="s1">&#39;new_fax_number&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span> <span class="p">]</span>


    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fax</span><span class="o">.</span><span class="n">rolodex</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">new_df</span> <span class="o">=</span> <span class="n">new_fax_df</span><span class="p">[[</span><span class="s1">&#39;new_fax_username&#39;</span><span class="p">,</span> <span class="s1">&#39;new_fax_number&#39;</span><span class="p">]]</span>
    <span class="c1"># rename columns to rolodex colums</span>
    <span class="n">new_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">cols</span>

    <span class="n">new_df</span> <span class="o">=</span> <span class="n">new_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="c1">#not already in the rolodex</span>
    <span class="n">net_new</span> <span class="o">=</span> <span class="n">new_df</span><span class="p">[(</span><span class="o">~</span><span class="n">new_df</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">fax</span><span class="o">.</span><span class="n">rolodex</span><span class="o">.</span><span class="n">handle</span><span class="p">))</span><span class="o">&amp;</span><span class="p">(</span><span class="o">~</span><span class="n">new_df</span><span class="o">.</span><span class="n">number</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">fax</span><span class="o">.</span><span class="n">rolodex</span><span class="o">.</span><span class="n">number</span><span class="p">))]</span> 

    <span class="n">fax</span><span class="o">.</span><span class="n">rolodex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">fax</span><span class="o">.</span><span class="n">rolodex</span><span class="p">,</span><span class="n">net_new</span><span class="p">])</span>

    <span class="n">materializer</span><span class="o">.</span><span class="n">write_fax_numbers</span><span class="p">(</span><span class="n">fax</span><span class="o">.</span><span class="n">rolodex</span><span class="p">)</span>

    <span class="c1">#put all this is the fweetdf, and return</span>
    <span class="n">fweet_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">not_add_fax_df</span><span class="p">,</span> <span class="n">add_fax_df</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># send a tweet that fax has been added</span>
    <span class="n">add_fax_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">twitter</span><span class="o">.</span><span class="n">send_tweet</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">twitter</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span> <span class="n">twitter</span><span class="o">.</span><span class="n">mode</span><span class="p">,),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fweet_df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_run_add_fax_number</span><span class="p">():</span>
    <span class="n">add_fax_df_fixture</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;status&quot;</span> <span class="p">:</span> <span class="s2">&quot;addfax&quot;</span><span class="p">,</span> <span class="s2">&quot;new_fax_username&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_username&quot;</span><span class="p">,</span> <span class="s2">&quot;new_fax_number&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_number&quot;</span><span class="p">,</span> <span class="s2">&quot;public_metrics.like_count&quot;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span> <span class="p">:</span> <span class="mi">12345</span><span class="p">,</span> <span class="s2">&quot;reply&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_reply&quot;</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1">#false statement</span>
    <span class="n">not_add_fax_df_fixture</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;status&quot;</span> <span class="p">:</span> <span class="s2">&quot;not_add_fax&quot;</span><span class="p">,</span> <span class="s2">&quot;new_fax_username&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_username&quot;</span><span class="p">,</span> <span class="s2">&quot;new_fax_number&quot;</span> <span class="p">:</span> <span class="s2">&quot;test_number&quot;</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1">#where status is not_add_fax, so should return the same thing</span>
    <span class="n">false_fixture</span> <span class="o">=</span> <span class="n">run_add_fax_number_step</span><span class="p">(</span><span class="n">not_add_fax_df_fixture</span><span class="p">)</span>


<span class="c1">#     assert false_fixture == </span>
<span class="c1">#         status new_fax_username new_fax_number</span>
<span class="c1"># 0  not_add_fax    test_username    test_number</span>



<span class="c1">#TEST TRUE CONDITION - commented out because of whitespace</span>


<span class="c1">#     true_fixture = run_add_fax_number_step(add_fax_df_fixture)</span>
<span class="c1">#     assert true_fixture ==                        created_at                   id               id_str  \</span>
<span class="c1"># 0   Sat May 08 16:40:47 +0000 2021  1391070586823221250  1391070586823221250   </span>
<span class="c1"># 1   Sat May 08 16:40:24 +0000 2021  1391070489574060034  1391070489574060034   </span>
<span class="c1"># 2   Sat May 08 16:39:57 +0000 2021  1391070378575810562  1391070378575810562   </span>
<span class="c1"># 3   Sat May 08 16:39:24 +0000 2021  1391070241145430018  1391070241145430018   </span>
<span class="c1"># 4   Sat May 08 16:38:59 +0000 2021  1391070135637716992  1391070135637716992   </span>
<span class="c1"># 5   Sat May 08 16:38:35 +0000 2021  1391070032105558022  1391070032105558022   </span>
<span class="c1"># 6   Sat May 08 16:38:06 +0000 2021  1391069912257466373  1391069912257466373   </span>
<span class="c1"># 7   Sat May 08 16:36:45 +0000 2021  1391069573026304003  1391069573026304003   </span>
<span class="c1"># 8   Sat May 08 16:36:22 +0000 2021  1391069476033019908  1391069476033019908   </span>
<span class="c1"># 9   Sat May 08 16:35:56 +0000 2021  1391069364703612936  1391069364703612936   </span>
<span class="c1"># 10  Sat May 08 16:35:29 +0000 2021  1391069253223206912  1391069253223206912   </span>
<span class="c1"># 11  Sat May 08 16:35:06 +0000 2021  1391069156791947264  1391069156791947264   </span>
<span class="c1"># 12  Sat May 08 16:34:44 +0000 2021  1391069063275745284  1391069063275745284   </span>
<span class="c1"># 13  Sat May 08 16:34:21 +0000 2021  1391068967167565827  1391068967167565827   </span>
<span class="c1"># 14  Sat May 08 16:33:36 +0000 2021  1391068779795341313  1391068779795341313   </span>
<span class="c1"># 15  Sat May 08 16:33:11 +0000 2021  1391068673360678912  1391068673360678912   </span>
<span class="c1"># 16  Sat May 08 16:32:47 +0000 2021  1391068573351677954  1391068573351677954   </span>
<span class="c1"># 17  Sat May 08 16:32:22 +0000 2021  1391068467923718155  1391068467923718155   </span>
<span class="c1"># 18  Sat May 08 16:31:50 +0000 2021  1391068336595902472  1391068336595902472   </span>
<span class="c1"># 19  Sat May 08 16:31:20 +0000 2021  1391068210334732289  1391068210334732289   </span>

<span class="c1">#                                                  text  truncated  \</span>
<span class="c1"># 0   @fweetmachine @SameerZuberi\n613-996-8478 http...      False   </span>
<span class="c1"># 1   @fweetmachine @bobzimmermp\n613-947-4527 https...      False   </span>
<span class="c1"># 2   @fweetmachine @ZannLenore\n613-992-7220 https:...      False   </span>
<span class="c1"># 3   @fweetmachine @SalmaZahid15\n613-943-1045 http...      False   </span>
<span class="c1"># 4   @fweetmachine @DavidYurdiga\n613-992-4603 http...      False   </span>
<span class="c1"># 5   @fweetmachine @KateYoungMP\n613-996-6772 https...      False   </span>
<span class="c1"># 6   @fweetmachine @JeanYip3\n613-995-1612 https://...      False   </span>
<span class="c1"># 7   @fweetmachine @Puglaas\n613-992-1460 https://t...      False   </span>
<span class="c1"># 8   @fweetmachine @JohnWilliamson_\n613-995-5226 h...      False   </span>
<span class="c1"># 9   @fweetmachine @JonathanWNV\n613-992-7319 https...      False   </span>
<span class="c1"># 10  @fweetmachine @PatrickBWeiler\n613-947-4620 ht...      False   </span>
<span class="c1"># 11  @fweetmachine @Webber4Confed\n613-992-2537 htt...      False   </span>
<span class="c1"># 12  @fweetmachine @KevinWaugh_CPC\n613-995-0126 ht...      False   </span>
<span class="c1"># 13  @fweetmachine @chriswarkentin\n613-947-4782 ht...      False   </span>
<span class="c1"># 14  @fweetmachine @cathayw\n 613-992-8676 https://...      False   </span>
<span class="c1"># 15  @fweetmachine @BradleyVis\n613-992-1298 https:...      False   </span>
<span class="c1"># 16  @fweetmachine @viraniarif\n613-995-1629 https:...      False   </span>
<span class="c1"># 17  @fweetmachine @JulieVignolaBL\n613-992-4544 ht...      False   </span>
<span class="c1"># 18  @fweetmachine @ArnoldViersen\n613-995-1415 htt...      False   </span>
<span class="c1"># 19  @fweetmachine @GaryAVidal\n613-995-7697 https:...      False   </span>

<span class="c1">#                                                source in_reply_to_status_id  \</span>
<span class="c1"># 0   &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 1   &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 2   &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 3   &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 4   &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 5   &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 6   &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 7   &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 8   &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 9   &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 10  &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 11  &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 12  &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 13  &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 14  &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 15  &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 16  &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 17  &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 18  &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>
<span class="c1"># 19  &lt;a href=&quot;https://mobile.twitter.com&quot; rel=&quot;nofo...                  None   </span>

<span class="c1">#    in_reply_to_status_id_str  in_reply_to_user_id in_reply_to_user_id_str  \</span>
<span class="c1"># 0                       None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 1                       None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 2                       None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 3                       None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 4                       None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 5                       None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 6                       None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 7                       None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 8                       None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 9                       None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 10                      None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 11                      None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 12                      None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 13                      None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 14                      None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 15                      None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 16                      None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 17                      None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 18                      None  1383517092553510913     1383517092553510913   </span>
<span class="c1"># 19                      None  1383517092553510913     1383517092553510913   </span>

<span class="c1">#     ... user.profile_text_color user.profile_use_background_image  \</span>
<span class="c1"># 0   ...                  333333                              True   </span>
<span class="c1"># 1   ...                  333333                              True   </span>
<span class="c1"># 2   ...                  333333                              True   </span>
<span class="c1"># 3   ...                  333333                              True   </span>
<span class="c1"># 4   ...                  333333                              True   </span>
<span class="c1"># 5   ...                  333333                              True   </span>
<span class="c1"># 6   ...                  333333                              True   </span>
<span class="c1"># 7   ...                  333333                              True   </span>
<span class="c1"># 8   ...                  333333                              True   </span>
<span class="c1"># 9   ...                  333333                              True   </span>
<span class="c1"># 10  ...                  333333                              True   </span>
<span class="c1"># 11  ...                  333333                              True   </span>
<span class="c1"># 12  ...                  333333                              True   </span>
<span class="c1"># 13  ...                  333333                              True   </span>
<span class="c1"># 14  ...                  333333                              True   </span>
<span class="c1"># 15  ...                  333333                              True   </span>
<span class="c1"># 16  ...                  333333                              True   </span>
<span class="c1"># 17  ...                  333333                              True   </span>
<span class="c1"># 18  ...                  333333                              True   </span>
<span class="c1"># 19  ...                  333333                              True   </span>

<span class="c1">#    user.has_extended_profile user.default_profile user.default_profile_image  \</span>
<span class="c1"># 0                       True                 True                      False   </span>
<span class="c1"># 1                       True                 True                      False   </span>
<span class="c1"># 2                       True                 True                      False   </span>
<span class="c1"># 3                       True                 True                      False   </span>
<span class="c1"># 4                       True                 True                      False   </span>
<span class="c1"># 5                       True                 True                      False   </span>
<span class="c1"># 6                       True                 True                      False   </span>
<span class="c1"># 7                       True                 True                      False   </span>
<span class="c1"># 8                       True                 True                      False   </span>
<span class="c1"># 9                       True                 True                      False   </span>
<span class="c1"># 10                      True                 True                      False   </span>
<span class="c1"># 11                      True                 True                      False   </span>
<span class="c1"># 12                      True                 True                      False   </span>
<span class="c1"># 13                      True                 True                      False   </span>
<span class="c1"># 14                      True                 True                      False   </span>
<span class="c1"># 15                      True                 True                      False   </span>
<span class="c1"># 16                      True                 True                      False   </span>
<span class="c1"># 17                      True                 True                      False   </span>
<span class="c1"># 18                      True                 True                      False   </span>
<span class="c1"># 19                      True                 True                      False   </span>

<span class="c1">#     user.following  user.follow_request_sent  user.notifications  \</span>
<span class="c1"># 0            False                     False               False   </span>
<span class="c1"># 1            False                     False               False   </span>
<span class="c1"># 2            False                     False               False   </span>
<span class="c1"># 3            False                     False               False   </span>
<span class="c1"># 4            False                     False               False   </span>
<span class="c1"># 5            False                     False               False   </span>
<span class="c1"># 6            False                     False               False   </span>
<span class="c1"># 7            False                     False               False   </span>
<span class="c1"># 8            False                     False               False   </span>
<span class="c1"># 9            False                     False               False   </span>
<span class="c1"># 10           False                     False               False   </span>
<span class="c1"># 11           False                     False               False   </span>
<span class="c1"># 12           False                     False               False   </span>
<span class="c1"># 13           False                     False               False   </span>
<span class="c1"># 14           False                     False               False   </span>
<span class="c1"># 15           False                     False               False   </span>
<span class="c1"># 16           False                     False               False   </span>
<span class="c1"># 17           False                     False               False   </span>
<span class="c1"># 18           False                     False               False   </span>
<span class="c1"># 19           False                     False               False   </span>

<span class="c1">#     user.translator_type  user.withheld_in_countries  </span>
<span class="c1"># 0                   none                          []  </span>
<span class="c1"># 1                   none                          []  </span>
<span class="c1"># 2                   none                          []  </span>
<span class="c1"># 3                   none                          []  </span>
<span class="c1"># 4                   none                          []  </span>
<span class="c1"># 5                   none                          []  </span>
<span class="c1"># 6                   none                          []  </span>
<span class="c1"># 7                   none                          []  </span>
<span class="c1"># 8                   none                          []  </span>
<span class="c1"># 9                   none                          []  </span>
<span class="c1"># 10                  none                          []  </span>
<span class="c1"># 11                  none                          []  </span>
<span class="c1"># 12                  none                          []  </span>
<span class="c1"># 13                  none                          []  </span>
<span class="c1"># 14                  none                          []  </span>
<span class="c1"># 15                  none                          []  </span>
<span class="c1"># 16                  none                          []  </span>
<span class="c1"># 17                  none                          []  </span>
<span class="c1"># 18                  none                          []  </span>
<span class="c1"># 19                  none                          [] </span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">run_set_instruction_step</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">,</span> <span class="n">mentions_df</span><span class="p">):</span>
    <span class="c1"># Set up the mapping for our aggregation functions.</span>
    <span class="c1"># By default all columns are &#39;first&#39;,</span>
    <span class="c1"># public_metrics fields are &#39;max&#39;,</span>
    <span class="c1"># This helps us determine net new mentions since last run.</span>
    
    <span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fweet_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">mentions_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="c1">#set the mapping[column of fweet and mention df] value to first</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">mapping</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;first&#39;</span>


    <span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;public_metrics.retweet_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span>
    <span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;public_metrics.reply_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span>
    <span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;public_metrics.like_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span>
    <span class="n">mapping</span><span class="p">[</span><span class="s1">&#39;public_metrics.quote_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span>


    <span class="n">mentions_df</span> <span class="o">=</span> <span class="n">mentions_df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;int64&#39;</span><span class="p">})</span>

    <span class="c1"># Combine the old mentions with the received new ones so we&#39;re operating on everything.</span>
    <span class="c1"># TODO: assign a fweet_id (uuidv4)</span>
    <span class="n">updated_concat_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
        <span class="n">fweet_df</span><span class="p">,</span> 
        <span class="c1">#if the id is not the same, concat the two dfs</span>
        <span class="n">mentions_df</span><span class="p">[</span><span class="o">~</span><span class="n">mentions_df</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">fweet_df</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span>
    <span class="p">])</span>

    <span class="c1"># Aggregate the combined old and new mentions to find what&#39;s net new and update public_metrics.</span>
    <span class="n">merged_fweet_df</span> <span class="o">=</span> <span class="n">updated_concat_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Look up fax numbers for everything without a status because we haven&#39;t operated on it yet.</span>
    <span class="n">net_new_rows</span> <span class="o">=</span> <span class="n">merged_fweet_df</span><span class="p">[</span><span class="n">merged_fweet_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
    <span class="n">not_new_rows</span> <span class="o">=</span> <span class="n">merged_fweet_df</span><span class="p">[</span><span class="o">~</span><span class="n">merged_fweet_df</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>

    
    <span class="k">if</span> <span class="n">net_new_rows</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fweet_df</span>


    <span class="c1">#?????????????? question</span>
    <span class="n">applied_new_rows</span> <span class="o">=</span> <span class="n">net_new_rows</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fax</span><span class="o">.</span><span class="n">set_instruction</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># if row status is null, it just returns the row??</span>

    <span class="n">fweet_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">not_new_rows</span><span class="p">,</span> <span class="n">applied_new_rows</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fweet_df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">test_set_instructions</span><span class="p">():</span>
    <span class="n">fweet_df_fixture_false</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;id&quot;</span> <span class="p">:</span> <span class="s2">&quot;fweet_id&quot;</span><span class="p">,</span> <span class="s2">&quot;fweet_col_1&quot;</span> <span class="p">:</span> <span class="s2">&quot;fweet_test&quot;</span><span class="p">,</span> <span class="s2">&quot;fweet_col_2&quot;</span><span class="p">:</span> <span class="s2">&quot;fweet_test2&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span> <span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">fweet_df_fixture_true</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;id&quot;</span> <span class="p">:</span> <span class="s2">&quot;fweet_id&quot;</span><span class="p">,</span> <span class="s2">&quot;fweet_col_1&quot;</span> <span class="p">:</span> <span class="s2">&quot;fweet_test&quot;</span><span class="p">,</span> <span class="s2">&quot;fweet_col_2&quot;</span><span class="p">:</span> <span class="s2">&quot;fweet_test2&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span> <span class="p">:</span> <span class="s2">&quot;value&quot;</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">mentions_df_fixture</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;mentions_col_1&quot;</span> <span class="p">:</span> <span class="s2">&quot;mentions_test&quot;</span><span class="p">,</span> <span class="s2">&quot;mentions_col_2&quot;</span><span class="p">:</span> <span class="s2">&quot;mentions_test2&quot;</span><span class="p">,</span> <span class="s2">&quot;mentions_col_3&quot;</span> <span class="p">:</span> <span class="s2">&quot;mentions_test&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span> <span class="p">:</span> <span class="mi">1236127763</span><span class="p">,</span> <span class="s2">&quot;public_metrics.like_count&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;public_metrics.quote_count&quot;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;public_metrics.reply_count&#39;</span> <span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;public_metrics.retweet_count&#39;</span> <span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;entities.hashtags&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;test_vals&quot;</span><span class="p">],</span> <span class="s2">&quot;conversation_id&quot;</span> <span class="p">:</span> <span class="mi">387167126</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1">#should just return concat results</span>
    <span class="n">false_result</span> <span class="o">=</span> <span class="n">run_set_instruction_step</span><span class="p">(</span><span class="n">fweet_df_fixture_false</span><span class="p">,</span> <span class="n">mentions_df_fixture</span><span class="p">)</span>
    <span class="c1"># assert false_result ==             id fweet_col_1  fweet_col_2  status mentions_col_1  mentions_col_2  \</span>
    <span class="c1">#                                     0  1236127763        None         None     NaN  mentions_test  mentions_test2   </span>
    <span class="c1">#                                     1    fweet_id  fweet_test  fweet_test2     NaN           None            None   </span>

    <span class="c1">#                                     mentions_col_3  public_metrics.like_count  public_metrics.quote_count  \</span>
    <span class="c1">#                                     0  mentions_test                        1.0                        10.0   </span>
    <span class="c1">#                                     1           None                        NaN                         NaN   </span>

    <span class="c1">#                                     public_metrics.reply_count  public_metrics.retweet_count  </span>
    <span class="c1">#                                     0                        20.0                          50.0  </span>
    <span class="c1">#                                     1                         NaN                           NaN </span>

    <span class="c1">#                                     public_metrics.reply_count  public_metrics.retweet_count  </span>
    <span class="c1">#                                     0                        20.0                          50.0  </span>
    <span class="c1">#                                     1                         NaN                           NaN </span>




    <span class="n">true_result</span> <span class="o">=</span> <span class="n">run_set_instruction_step</span><span class="p">(</span><span class="n">fweet_df_fixture_true</span><span class="p">,</span> <span class="n">mentions_df_fixture</span><span class="p">)</span>


<span class="c1">#    assert true_result == </span>
<span class="c1">#                             id fweet_col_1  fweet_col_2 status mentions_col_1  mentions_col_2  \</span>
<span class="c1">#                     0    fweet_id  fweet_test  fweet_test2  value           None            None   </span>
<span class="c1">#                     1  1236127763        None         None  fweet  mentions_test  mentions_test2   </span>

<span class="c1">#                     mentions_col_3  public_metrics.like_count  public_metrics.quote_count  \</span>
<span class="c1">#                     0           None                        NaN                         NaN   </span>
<span class="c1">#                     1  mentions_test                        1.0                        10.0   </span>

<span class="c1">#                     public_metrics.reply_count  public_metrics.retweet_count entities.hashtags  \</span>
<span class="c1">#                     0                         NaN                           NaN              None   </span>
<span class="c1">#                     1                        20.0                          50.0         test_vals   </span>

<span class="c1">#                     conversation_id  </span>
<span class="c1">#                     0              NaN  </span>
<span class="c1"># 1      387167126.0 </span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="RUN">RUN<a class="anchor-link" href="#RUN"> </a></h1><hr>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">run_bootstrap_step</span><span class="p">()</span>

<span class="c1">##call all test functions only if in DEV mode</span>
<span class="c1">#if (os.environ.get(&#39;FWEET_ENV&#39;, &#39;DEV&#39;) == &quot;DEV&quot;):</span>
    <span class="c1"># test_fetch_mentions()</span>
    <span class="c1">#test_fetch_favorites() </span>
    <span class="c1"># test_map_media_to_tweet()</span>
    <span class="c1">#test_get_tweet_content()</span>
    <span class="c1">#test_map_media_to_tweet()</span>
    <span class="c1"># test_map_username_to_fweet()</span>
    <span class="c1">#test_upload_media()</span>
    <span class="c1">#test_send_tweet()</span>
    <span class="c1"># test_set_instructions()</span>
    <span class="c1"># test_fax_run()</span>
    <span class="c1">#test_parse_fax_number()</span>
    <span class="c1"># test_map_fax()</span>
    <span class="c1">#test_pending_df()</span>
    <span class="c1">#test_generate_jpg_from_pdf()</span>
    <span class="c1">#test_analyze_mentions()</span>
    <span class="c1">#test_run_add_fax_number()</span>
    <span class="c1">#test_set_instructions()</span>


<span class="n">fweet_df</span> <span class="o">=</span> <span class="n">materializer</span><span class="o">.</span><span class="n">get_fweet_df</span><span class="p">()</span>
<span class="n">mentions_df</span><span class="p">,</span> <span class="n">media</span><span class="p">,</span> <span class="n">users</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">fetch_mentions</span><span class="p">()</span>

<span class="n">fweet_df</span> <span class="o">=</span> <span class="n">run_set_instruction_step</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">,</span> <span class="n">mentions_df</span><span class="p">)</span>

<span class="c1"># # TODO: the next steps can run in parallel when supported</span>

<span class="c1"># #add new fax numbers to the rolodex</span>
<span class="n">fweet_df</span> <span class="o">=</span> <span class="n">run_add_fax_number_step</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">)</span>

<span class="c1"># #for fweets whose status is pending or recieved, populate all the information of the users, and raise error id denied</span>
<span class="n">fweet_df</span> <span class="o">=</span> <span class="n">run_received_step</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">,</span> <span class="n">media</span><span class="p">,</span> <span class="n">users</span><span class="p">)</span>

<span class="c1"># #set status as recieved, reason and reply for df that has been recieved and set status as pending, and for those that have been denied, as dead letter</span>
<span class="n">fweet_df</span> <span class="o">=</span> <span class="n">run_approval_step</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">)</span>

<span class="c1"># #send out the tweets for the pending status, if the fax machine has money, with pdf of fax turned to jpeg</span>
<span class="n">fweet_df</span> <span class="o">=</span> <span class="n">run_fax_step</span><span class="p">(</span><span class="n">fweet_df</span><span class="p">)</span>

<span class="c1"># # TODO this step should remove compelte (success or not) to a respective blob</span>
<span class="c1"># #just adds the completed status to the fax </span>
<span class="n">fweet_df</span> <span class="o">=</span> <span class="n">run_completed_step</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

